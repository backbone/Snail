#!/bin/bash

PATH=/usr/local/sbin:/usr/local/bin:$PATH

TIMEOUT=10           # wait timeout for X server start
let INTEL_IF_FAIL=1 # run on Intel if nVidia fails

SERVICE=/etc/init.d/snail-xserver
PROC=nvrun

LOCK_FILE=/tmp/.snail.lock
FIFO_FILE=/tmp/.snail.fifo


{
  echo -n > $FIFO_FILE &
  flock -w $TIMEOUT -s 9

  if [ 0 -eq $? ]; then
	echo "Running $@ on nVidia"
	LD_PRELOAD="/usr/lib/opengl/nvidia/lib/libGL.so:/usr/lib/opengl/nvidia/lib/libnvidia-tls.so" snail.vglrun -d :1 "$@"
	echo "Application $@ was performed on nVidia"

  elif [ 0 -ne $INTEL_IF_FAIL ]; then
	echo "Running $@ on Intel"
	"$@"
	echo "Application $@ was performed on Intel"
  fi

  flock -u 9

} 9>$LOCK_FILE
